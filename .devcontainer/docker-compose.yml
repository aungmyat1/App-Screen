version: '3.8'

services:
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ../..:/workspaces:cached
      - node_modules:/workspaces/App-Screen/node_modules  # Persist node_modules
    # Overrides default command so things don't shut down after the process ends
    command: sleep infinity
    environment:
      - DATABASE_URL=postgresql://appscreens_user:appscreens_pass@postgres:5432/appscreens
      - REDIS_URL=redis://redis:6379
    network_mode: service:postgres  # Connect to postgres network to access both db and redis
    
  postgres:
    image: postgres:15
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: appscreens
      POSTGRES_USER: appscreens_user
      POSTGRES_PASSWORD: appscreens_pass
    # Use different port to avoid conflict if postgres is running locally
    ports:
      - "54320:5432"  # Maps to 54320 on host, 5432 in container
    
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    # Use different port to avoid conflict if redis is running locally
    ports:
      - "63790:6379"  # Maps to 63790 on host, 6379 in container

volumes:
  postgres_data:
  redis_data:
  node_modules: